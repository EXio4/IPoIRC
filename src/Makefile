PREFIX = /usr/local
# no-writable-strings will be disabled until I switch to a YAML config.
CXXFLAGS ?= -Wall -Wextra -O0 -g `dnet-config --cflags` -std=c++11 -Wno-writable-strings
LIBS = -lpthread `dnet-config --libs` -lzmq -lircclient -lcrypto -lm -lbsd -lpcre -lconfuse
OBJS = ipoirc.o irc.o irc_events.o irc_helpers.o ltun.o tun.o tun_helpers.o helpers.o base64.o
TARGET = ipoirc

.build-gen:
	@echo '/**' > build-gen.h
	@echo ' * This file is automatically generated. Do NOT modify it unless you know' >> build-gen.h
	@echo ' * what you'\''re doing.' >> build-gen.h
	@echo ' */' >> build-gen.h
	@echo >> build-gen.h
	@echo '#ifndef _IPOIRC_BUILD_GEN_H' >> build-gen.h
	@echo '#define _IPOIRC_BUILD_GEN_H' >> build-gen.h
	@echo >> build-gen.h

	@if ! hash dnet 2>/dev/null && hash dumbnet-config 2>/dev/null; then \
		echo '#define IPOIRC_BUILD_DUMBNET' >> build-gen.h; \
	else \
		echo '#define IPOIRC_BUILD_DNET' >> build-gen.h; \
	fi

	@# FIXME: This will ignore libircclient elsewhere in the include path if
	@# the libircclient-dev package is installed under Debian.
	@if ! [ -f /usr/include/libircclient.h ] && \
			[ -f /usr/include/libircclient/libircclient.h ]; then \
		echo '#define IPOIRC_BUILD_LIBIRCCLIENT_LIBIRCCLIENT' >> build-gen.h; \
	else \
		echo '#define IPOIRC_BUILD_LIBIRCCLIENT' >> build-gen.h; \
	fi

	@echo >> build-gen.h
	@echo '#endif' >> build-gen.h

all: .build-gen $(TARGET)

$(TARGET): $(OBJS)
	$(CXX) $(LDFLAGS) -o $@ $^ $(LIBS)

tests:
	$(CXX) -o b64test -DTESTS -Wall base64.c -lm -lcrypto

%.o: %.cxx
	$(CXX) $(CXXFLAGS)  $(DEFINES) -o $@ -c $<

install: $(TARGET)
	mkdir -p $(PREFIX)/bin
	install -p -m 755 $(TARGET) $(PREFIX)/bin

clean:
	rm -f $(OBJS) $(TARGET) b64test build-gen.h *~

uninstall:
	rm -f $(PREFIX)/bin/$(TARGET)

run: $(TARGET)
	./$(TARGET) $@

